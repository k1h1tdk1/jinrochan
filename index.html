<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>人狼メモ（モバイル対応）</title>
  <meta name="theme-color" content="#111" />
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="icon-192.png" />
  <style>
    :root{
      --bg:#0e0f12; --card:#171a1f; --muted:#99a2ad; --accent:#6ea8fe; --accent2:#e66c97;
      --ok:#3ecf8e; --warn:#ffcc00; --bad:#ff6262; --border:#2a2f3a;
    }
    *{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
    body{margin:0;background:var(--bg);color:#fff;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,rgba(14,15,18,.95),rgba(14,15,18,.85));backdrop-filter: blur(8px);border-bottom:1px solid var(--border);}
    .bar{display:flex;gap:.5rem;align-items:center; padding:.75rem .75rem; flex-wrap:wrap}
    .brand{font-weight:700;letter-spacing:.3px}
    .btn{appearance:none;border:1px solid var(--border);background:var(--card);color:#fff;border-radius:12px;padding:.55rem .8rem;font-size:.95rem;display:inline-flex;gap:.4rem;align-items:center}
    .btn:active{transform: translateY(1px)}
    .btn.primary{border-color:transparent;background:linear-gradient(180deg,#2a62ff,#244fe0)}
    .btn.warn{background:#3a2a00;border-color:#5a4300}
    .btn.ghost{background:transparent}
    .grow{flex:1}
    .grid{display:grid; gap:.75rem; padding:.75rem}
    @media (min-width:840px){ .grid{grid-template-columns: 1fr 1fr} }
    .zone{background:var(--card); border:1px solid var(--border); border-radius:16px; padding:.6rem}
    .zone h3{margin:.25rem 0 .5rem 0;font-size:1rem;display:flex;align-items:center;gap:.5rem;color:var(--muted)}
    .lane{min-height:92px; display:flex; flex-wrap:wrap; gap:.5rem; padding-bottom:.25rem}
    .chip{user-select:none; -webkit-user-select:none; touch-action:none;
      display:inline-flex; align-items:center; gap:.4rem;
      background:#1f2430; border:1px solid var(--border); border-radius:999px;
      padding:.4rem .6rem; font-weight:600; font-size:.95rem;
    }
    .chip[data-role="占"]{border-color:#6ea8fe}
    .chip[data-role="霊"]{border-color:#8f7bff}
    .chip[data-role="騎"]{border-color:#3ecf8e}
    .chip.dead{opacity:.55; text-decoration: line-through; border-color:#444}
    .chip .tag{font-size:.75rem; color:var(--muted)}
    .chip .drag-handle{font-size:1.1rem;opacity:.7}
    .pill{font-size:.7rem;padding:.15rem .45rem;border-radius:999px;border:1px solid var(--border);background:#111;opacity:.9}
    .pill.ok{border-color:#214d3b;color:#9ee6c6}
    .pill.warn{border-color:#5a4300;color:#ffd77a}
    .pill.bad{border-color:#5a1f1f;color:#ff9c9c}
    .meta{display:flex; gap:.5rem; flex-wrap:wrap}
    textarea{width:100%; min-height:120px; border-radius:12px; border:1px solid var(--border); background:#0f1116; color:#fff; padding:.75rem; font-size:.95rem; resize:vertical}
    .footer{padding:1rem;color:var(--muted);text-align:center}
    .hr{height:1px;background:var(--border);margin:.5rem 0 .75rem}
    .small{font-size:.85rem;color:var(--muted)}
    /* drag visual */
    .dragging{opacity:.7; transform: scale(.98)}
    .drop-target{outline:2px dashed #2a62ff; outline-offset: 4px; border-radius:12px}
    /* modal */
    dialog{border:none;border-radius:16px;background:#1a1f27;color:#fff;max-width:560px;width:92vw}
    dialog::backdrop{background:rgba(0,0,0,.5)}
    .row{display:flex;gap:.5rem;align-items:center;margin:.5rem 0}
    input, select{width:100%;border-radius:12px;border:1px solid var(--border);background:#0f1116;color:#fff;padding:.6rem}
    label{font-size:.9rem;color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="brand">人狼メモ（PWA）</div>
      <button id="addBtn" class="btn">＋ プレイヤー</button>
      <button id="presetsBtn" class="btn">9人村プリセット</button>
      <button id="saveBtn" class="btn primary">保存</button>
      <button id="loadBtn" class="btn">読込</button>
      <div class="grow"></div>
      <button id="exportBtn" class="btn ghost">エクスポート</button>
      <button id="importBtn" class="btn ghost">インポート</button>
    </div>
  </header>

  <main class="grid">
    <!-- 左：ボード -->
    <section class="zone">
      <h3>ボード（ドラッグで配置）</h3>
      <div class="meta" style="margin:.25rem 0 .6rem">
        <span class="pill ok">白</span>
        <span class="pill">灰</span>
        <span class="pill warn">要注目</span>
        <span class="pill bad">黒候補</span>
        <span class="pill">確黒</span>
        <span class="pill">死亡</span>
        <span class="pill">未分類</span>
      </div>
      <div class="hr"></div>
      <div class="lane drop" data-lane="white" aria-label="白"></div>
      <div class="lane drop" data-lane="gray" aria-label="灰"></div>
      <div class="lane drop" data-lane="watch" aria-label="要注目"></div>
      <div class="lane drop" data-lane="black" aria-label="黒候補"></div>
      <div class="lane drop" data-lane="evil" aria-label="確黒"></div>
      <div class="lane drop" data-lane="dead" aria-label="死亡"></div>
      <div class="lane drop" data-lane="pool" aria-label="未分類"></div>
    </section>

    <!-- 右：ノート -->
    <section class="zone">
      <h3>ノート</h3>
      <textarea id="notes" placeholder="例：2番の視点漏れ／5番は自吊りブラフ？&#10;※人狼メトロポリスはCOが画面表示されるので誰がCOしたかは書かなくてOK！"></textarea>
      <div class="row">
        <label class="small">ヒント：長押しでプレイヤーをつかんで移動。タップで死亡線＆役職タグ切替。</label>
      </div>
    </section>
  </main>

  <div class="footer small">ローカル保存／オフライン対応。ホーム画面に追加OK。</div>

  <!-- 追加モーダル -->
  <dialog id="addDialog">
    <form method="dialog">
      <h3>プレイヤー追加</h3>
      <div class="row">
        <label style="min-width:5rem">表示名</label>
        <input id="pName" placeholder="例：1, 2, みく, 顎 など" />
      </div>
      <div class="row">
        <label style="min-width:5rem">役職タグ（任意）</label>
        <select id="pRole">
          <option value="">（なし）</option>
          <option value="占">占</option>
          <option value="霊">霊</option>
          <option value="騎">騎</option>
          <option value="狂">狂</option>
          <option value="狼">狼</option>
          <option value="村">村</option>
        </select>
      </div>
      <div class="row" style="justify-content:flex-end">
        <button class="btn">キャンセル</button>
        <button id="addSubmit" class="btn primary">追加</button>
      </div>
    </form>
  </dialog>

  <!-- 読込モーダル -->
  <dialog id="loadDialog">
    <form method="dialog">
      <h3>保存スロット</h3>
      <div class="row"><select id="slotSel"></select></div>
      <div class="row" style="justify-content:flex-end">
        <button class="btn">閉じる</button>
        <button id="loadSubmit" class="btn primary">読込</button>
      </div>
    </form>
  </dialog>

  <input type="file" id="hiddenImport" accept="application/json" style="display:none"/>

  <script>
  // ======= 状態 =======
  const SLOTS_KEY = "jinro_slots_v1";
  const STATE_KEY = "jinro_state_v1";
  let state = {
    lanes: {white:[],gray:[],watch:[],black:[],evil:[],dead:[],pool:[]},
    notes: ""
  };
  const $ = s=>document.querySelector(s);
  const $$ = s=>Array.from(document.querySelectorAll(s));

  // ======= 初期化 =======
  (function init(){
    const cached = localStorage.getItem(STATE_KEY);
    if(cached){ try{ state = JSON.parse(cached); }catch{} }
    renderAll();
    // PWA
    if('serviceWorker' in navigator){ navigator.serviceWorker.register('sw.js'); }
  })();

  // ======= UIイベント =======
  $("#addBtn").addEventListener("click", ()=>$("#addDialog").showModal());
  $("#presetsBtn").addEventListener("click", applyNinePreset);
  $("#addSubmit").addEventListener("click", (e)=>{
    e.preventDefault();
    const name = $("#pName").value.trim();
    if(!name) return;
    const role = $("#pRole").value;
    addPlayer({name, role, dead:false}, 'pool');
    $("#pName").value=""; $("#pRole").value="";
    $("#addDialog").close();
    saveLocal();
  });

  $("#notes").addEventListener("input", ()=>{
    state.notes = $("#notes").value;
    saveLocalDebounced();
  });

  $("#saveBtn").addEventListener("click", ()=>{
    const slots = JSON.parse(localStorage.getItem(SLOTS_KEY) || "[]");
    const stamp = new Date().toLocaleString();
    slots.unshift({id:crypto.randomUUID(), at:stamp, data:state});
    localStorage.setItem(SLOTS_KEY, JSON.stringify(slots.slice(0,20)));
    alert("保存したよ（最大20件）");
  });

  $("#loadBtn").addEventListener("click", ()=>{
    const slots = JSON.parse(localStorage.getItem(SLOTS_KEY) || "[]");
    const sel = $("#slotSel");
    sel.innerHTML = "";
    if(slots.length===0){
      const o = document.createElement("option");
      o.textContent = "保存がないよ"; sel.appendChild(o);
    }else{
      for(const s of slots){
        const o = document.createElement("option");
        o.value = s.id;
        o.textContent = s.at;
        sel.appendChild(o);
      }
    }
    $("#loadDialog").showModal();
  });

  $("#loadSubmit").addEventListener("click",(e)=>{
    e.preventDefault();
    const id = $("#slotSel").value;
    const slots = JSON.parse(localStorage.getItem(SLOTS_KEY) || "[]");
    const hit = slots.find(s=>s.id===id);
    if(hit){
      state = JSON.parse(JSON.stringify(hit.data));
      renderAll();
      saveLocal();
      $("#loadDialog").close();
    }
  });

  $("#exportBtn").addEventListener("click", ()=>{
    const blob = new Blob([JSON.stringify(state,null,2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = "jinro-memo.json"; a.click();
    URL.revokeObjectURL(url);
  });

  $("#importBtn").addEventListener("click", ()=>$("#hiddenImport").click());
  $("#hiddenImport").addEventListener("change", (e)=>{
    const file = e.target.files?.[0];
    if(!file) return;
    const fr = new FileReader();
    fr.onload = ()=>{
      try{
        const obj = JSON.parse(fr.result);
        if(obj?.lanes && obj?.notes !== undefined){
          state = obj; renderAll(); saveLocal();
        }else{ alert("不正なデータだよ"); }
      }catch{ alert("読み込み失敗；；"); }
      e.target.value="";
    };
    fr.readAsText(file);
  });

  // ======= プレイヤー描画 =======
  function renderAll(){
    for(const lane of Object.keys(state.lanes)){
      const el = document.querySelector(`.lane[data-lane="${lane}"]`);
      el.innerHTML="";
      for(const p of state.lanes[lane]){
        el.appendChild(renderChip(p));
      }
    }
    $("#notes").value = state.notes || "";
  }

  function renderChip(p){
    const el = document.createElement("div");
    el.className = "chip";
    if(p.dead) el.classList.add("dead");
    el.setAttribute("data-name", p.name);
    if(p.role) el.setAttribute("data-role", p.role);

    const handle = document.createElement("span");
    handle.className="drag-handle";
    handle.textContent="⋮⋮";
    el.appendChild(handle);

    const name = document.createElement("span");
    name.textContent = p.name;
    el.appendChild(name);

    if(p.role){
      const tag = document.createElement("span");
      tag.className="tag";
      tag.textContent = p.role;
      el.appendChild(tag);
    }

    // タップで「死亡」トグル→長押しでドラッグ
    let pressTimer=null, dragging=false;
    el.addEventListener("pointerdown",(ev)=>{
      ev.preventDefault();
      el.setPointerCapture(ev.pointerId);
      const startX=ev.clientX, startY=ev.clientY;
      pressTimer = setTimeout(()=>startDrag(ev, el, p), 120); // 長押しでドラッグ開始
      function move(e){
        const dx=Math.abs(e.clientX-startX), dy=Math.abs(e.clientY-startY);
        if(dx>8 || dy>8){ /* 指が動いたらドラッグ優先 */ }
      }
      function up(e){
        clearTimeout(pressTimer);
        el.removeEventListener("pointermove", move);
        el.removeEventListener("pointerup", up);
        if(!dragging){
          // 単タップ：死亡トグル
          p.dead = !p.dead;
          el.classList.toggle("dead", p.dead);
          saveLocal();
        }
      }
      el.addEventListener("pointermove", move);
      el.addEventListener("pointerup", up,{once:true});
    });

    function startDrag(ev, el, p){
      dragging=true;
      el.classList.add("dragging");
      const ghost = el.cloneNode(true);
      ghost.style.position="fixed";
      ghost.style.left=ev.clientX+"px";
      ghost.style.top=ev.clientY+"px";
      ghost.style.pointerEvents="none";
      ghost.style.transform="translate(-50%, -50%)";
      document.body.appendChild(ghost);

      function onMove(e){
        ghost.style.left=e.clientX+"px";
        ghost.style.top=e.clientY+"px";
        const target = document.elementFromPoint(e.clientX, e.clientY);
        $$(".drop").forEach(d=>d.classList.remove("drop-target"));
        const lane = target?.closest?.(".drop");
        if(lane){ lane.classList.add("drop-target"); }
      }
      function onUp(e){
        document.removeEventListener("pointermove", onMove);
        document.removeEventListener("pointerup", onUp);
        ghost.remove(); el.classList.remove("dragging"); dragging=false;
        $$(".drop").forEach(d=>d.classList.remove("drop-target"));
        const target = document.elementFromPoint(e.clientX, e.clientY);
        const laneEl = target?.closest?.(".drop");
        if(laneEl){
          movePlayerToLane(p, laneEl.dataset.lane);
        }
      }
      document.addEventListener("pointermove", onMove);
      document.addEventListener("pointerup", onUp, {once:true});
    }

    // 役職タグのクイック切替（長押ししながら名前部分をタップ）
    el.addEventListener("dblclick", ()=>{
      const roles = ["","占","霊","騎","狂","狼","村"];
      const idx = roles.indexOf(p.role||"");
      p.role = roles[(idx+1)%roles.length] || "";
      if(p.role){ el.setAttribute("data-role", p.role); }
      else{ el.removeAttribute("data-role"); }
      renderAll(); saveLocal();
    });

    return el;
  }

  function movePlayerToLane(p, toLane){
    // いまのレーンから削除
    for(const lane of Object.keys(state.lanes)){
      const i = state.lanes[lane].indexOf(p);
      if(i>=0){ state.lanes[lane].splice(i,1); break; }
    }
    // 追加
    state.lanes[toLane].push(p);
    renderAll(); saveLocal();
  }

  function addPlayer(p, lane='pool'){
    state.lanes[lane].push(p);
    renderAll();
  }

  // 9人霊媒局プリセット（1〜9を未分類に）
  function applyNinePreset(){
    state = {
      lanes:{white:[],gray:[],watch:[],black:[],evil:[],dead:[],pool:[]},
      notes:""
    };
    for(let i=1;i<=9;i++) addPlayer({name:String(i), role:i<=3?"":"", dead:false}, 'pool');
    saveLocal();
  }

  // ======= 保存 =======
  function saveLocal(){
    localStorage.setItem(STATE_KEY, JSON.stringify(state));
  }
  let t=null;
  function saveLocalDebounced(){ clearTimeout(t); t=setTimeout(saveLocal, 250); }
  </script>
</body>
</html>
